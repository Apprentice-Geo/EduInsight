<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>正在分析 - 学情预警分析系统</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        padding: 50px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        color: white;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }
      h1 {
        font-size: 28px;
        margin-bottom: 20px;
        color: white;
      }
      .user-info {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 30px;
        font-size: 18px;
      }
      .loader {
        border: 8px solid rgba(255, 255, 255, 0.2);
        border-top: 8px solid #fff;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1.5s linear infinite;
        margin: 30px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .status-text {
        font-size: 18px;
        margin: 20px 0;
        line-height: 1.6;
      }
      .progress-steps {
        text-align: left;
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .step {
        margin: 10px 0;
        padding: 8px 0;
        font-size: 16px;
      }
      .step.active {
        color: #ffd700;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🤖 AI正在分析您的数据...</h1>

      <div class="user-info">
        <strong>{{ username }}</strong>，您的分析任务已开始
      </div>

      <div class="loader"></div>

      <div class="status-text">
        系统正在使用机器学习算法分析学生数据，请稍候片刻...
      </div>

      <div class="progress-steps">
        <div class="step active">✅ 数据上传完成</div>
        <div class="step active">🔄 特征提取中...</div>
        <div class="step">🧠 机器学习分析</div>
        <div class="step">📊 生成预警报告</div>
        <div class="step">✨ 分析完成</div>
      </div>

      <p class="status-text">分析完成后将自动跳转到结果页面</p>
    </div>

    <script>
      const userId = "{{ user_id }}";
      let stepIndex = 1;
      const steps = document.querySelectorAll(".step");

      // 模拟进度更新
      const updateProgress = () => {
        if (stepIndex < steps.length - 1) {
          steps[stepIndex].classList.add("active");
          stepIndex++;
        }
      };

      const checkStatus = () => {
        fetch(`/api/status/${userId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "completed") {
              // 完成所有步骤
              steps.forEach((step) => step.classList.add("active"));
              setTimeout(() => {
                window.location.href = `/results/${userId}`;
              }, 1500);
            } else if (data.status === "error") {
              document.querySelector(".status-text").innerHTML =
                "❌ 分析过程中出现错误，请返回重新上传文件";
            } else {
              // 更新进度
              updateProgress();
              // 5秒后再次检查
              setTimeout(checkStatus, 5000);
            }
          })
          .catch((error) => {
            console.error("Error checking status:", error);
            // 出错也继续重试
            setTimeout(checkStatus, 8000);
          });
      };

      // 页面加载后开始检查状态和进度动画
      window.onload = () => {
        checkStatus();
        // 每3秒更新一次进度显示
        setInterval(updateProgress, 3000);
      };
    </script>
  </body>
</html>
